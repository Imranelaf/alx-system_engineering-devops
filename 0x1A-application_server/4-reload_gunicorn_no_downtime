#!/usr/bin/env bash
# Gracefully reloads Gunicorn.

# Find Gunicorn process IDs
gunicorn_pids=$(pgrep gunicorn)

if [ -z "$gunicorn_pids" ]; then
    echo "No Gunicorn processes found."
    exit 1
fi

# Logging function
log() {
    echo "$(date +"%Y-%m-%d %T"): $1"
}

# Stop old workers gracefully
log "Stopping old workers gracefully..."
for pid in $gunicorn_pids; do
    if kill -HUP "$pid"; then
        log "Sent HUP signal to $pid"
    else
        log "Failed to send HUP signal to $pid"
    fi
done

# Wait for old workers to finish processing
wait_duration=5
log "Waiting for old workers to finish processing for $wait_duration seconds..."
sleep "$wait_duration"

log "Graceful reload complete"
